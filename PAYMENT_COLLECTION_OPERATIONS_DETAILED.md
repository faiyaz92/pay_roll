# Payment Collection Operations - Section 5 Buttons

## Overview
This document details the exact database operations performed by the 4 payment buttons in Section 5 of the Financial Accounts Tab. Each button performs **exactly 3 database operations** across **3 collections**, creating/updating **3-4 documents** total.

## The 4 Payment Buttons

### 1. GST Payment Button (`handleGstPayment`)
### 2. Service Charge Collection Button (`handleServiceChargeCollection`)
### 3. Partner Payment Button (`handlePartnerPayment`)
### 4. Owner's Share Collection Button (`handleOwnerShareCollection`)

---

## Database Operations Summary

### Collections Updated (All 4 Buttons)
1. **`accountingTransactions`** - Creates transaction records
2. **`cashInHand`** - Updates vehicle-specific cash balance
3. **`companyCashInHand`** - Updates company-wide cash balance

### Documents Modified Per Button
- **accountingTransactions**: 1 document (or multiple for bulk quarterly/yearly payments)
- **cashInHand**: 1 document (vehicle-specific)
- **companyCashInHand**: 1 document (company-wide 'main' document)

---

## Detailed Field Specifications

### 1. accountingTransactions Collection

**Collection Path:**
```
Easy2Solutions/companyDirectory/tenantCompanies/{companyId}/accountingTransactions
```

**Document Structure (All 4 Buttons):**

| Field | Type | Description | Example Value |
|-------|------|-------------|---------------|
| `vehicleId` | `string` | Firestore document ID of the vehicle | `"abc123def456"` |
| `type` | `string` | Payment type identifier | `'gst_payment'`, `'service_charge'`, `'partner_payment'`, `'owner_share'` |
| `amount` | `number` | Payment amount in rupees | `4500.00`, `12500.50` |
| `month` | `string` | Period string (YYYY-MM format) | `"2025-01"`, `"2025-11"` |
| `description` | `string` | Human-readable payment description | `"GST Payment for MH12AB1234 - January 2025"` |
| `status` | `string` | Transaction status (always 'completed') | `"completed"` |
| `createdAt` | `string` | ISO timestamp when transaction created | `"2025-11-15T14:30:25.123Z"` |
| `completedAt` | `string` | ISO timestamp when transaction completed | `"2025-11-15T14:30:25.123Z"` |

**Date Storage Format:**
- **Stored as:** ISO 8601 string format
- **Generated by:** `new Date().toISOString()`
- **Example:** `"2025-11-15T14:30:25.123Z"`
- **Firebase Type:** Stored as string, retrieved as Firestore Timestamp object

---

### 2. cashInHand Collection

**Collection Path:**
```
Easy2Solutions/companyDirectory/tenantCompanies/{companyId}/cashInHand
```

**Document ID:** `{vehicleId}` (same as vehicle Firestore document ID)

**Document Structure:**

| Field | Type | Description | Example Value |
|-------|------|-------------|---------------|
| `balance` | `number` | Vehicle's current cash balance | `50000.00`, `-2500.50` |

**Update Operation:**
```javascript
await setDoc(cashRef, {
  balance: increment(-paymentAmount)  // DECREASES balance
}, { merge: true });
```

---

### 3. companyCashInHand Collection

**Collection Path:**
```
Easy2Solutions/companyDirectory/tenantCompanies/{companyId}/companyCashInHand
```

**Document ID:** `'main'` (fixed)

**Document Structure:**

| Field | Type | Description | Example Value |
|-------|------|-------------|---------------|
| `balance` | `number` | Company's total cash balance | `250000.00`, `187500.50` |
| `lastUpdated` | `string` | ISO timestamp of last update | `"2025-11-15T14:30:25.123Z"` |

**Update Operation:**
```javascript
await setDoc(companyCashRef, {
  balance: increment(-paymentAmount),  // DECREASES balance
  lastUpdated: new Date().toISOString()
}, { merge: true });
```

---

## Button-Specific Details

### 1. GST Payment Button

**Transaction Fields:**
- `type`: `'gst_payment'`
- `amount`: `vehicleInfo.gstAmount / monthsInPeriod * selectedMonths.length`
- `description`: `"GST Payment for {registrationNumber} - {periodLabel} {year}"`

**Amount Source:** `vehicleInfo.gstAmount`

### 2. Service Charge Collection Button

**Transaction Fields:**
- `type`: `'service_charge'`
- `amount`: `vehicleInfo.serviceCharge / monthsInPeriod * selectedMonths.length`
- `description`: `"Service Charge Collection for {registrationNumber} - {periodLabel} {year}"`

**Amount Source:** `vehicleInfo.serviceCharge`

### 3. Partner Payment Button

**Transaction Fields:**
- `type`: `'partner_payment'`
- `amount`: `vehicleInfo.partnerShare / monthsInPeriod * selectedMonths.length`
- `description`: `"Partner Payment for {registrationNumber} - {periodLabel} {year}"`

**Amount Source:** `vehicleInfo.partnerShare`

### 4. Owner's Share Collection Button

**Transaction Fields:**
- `type`: `'owner_share'`
- `amount`: `vehicleInfo.ownerShare` (or calculated for selected months)
- `description`: `"Owner's Share Collection for {registrationNumber} - {periodLabel} {year}"`

**Amount Source:** `vehicleInfo.ownerShare`

---

## Bulk Payment Behavior

For **quarterly/yearly periods** with month selection:

### Multiple Transactions Created
- **GST/Service/Partner payments:** Create 1 transaction per selected month
- **Owner's share:** Creates 1 transaction with total amount for selected months

### Example: Quarterly GST Payment (3 months selected)
```
Creates 3 documents in accountingTransactions:
- Month "2025-01": amount = gstAmount/3
- Month "2025-02": amount = gstAmount/3  
- Month "2025-03": amount = gstAmount/3

Updates 1 document in cashInHand: balance -= gstAmount
Updates 1 document in companyCashInHand: balance -= gstAmount
```

---

## Date Handling in Firebase

### Storage Format
```javascript
// How dates are stored in Firestore documents
createdAt: new Date().toISOString()  // "2025-11-15T14:30:25.123Z"
completedAt: new Date().toISOString() // "2025-11-15T14:30:25.123Z"
lastUpdated: new Date().toISOString() // "2025-11-15T14:30:25.123Z"
```

### Retrieval Format
```javascript
// How dates are retrieved from Firestore
const transaction = doc.data();
// transaction.createdAt is now a Firestore Timestamp object
// transaction.completedAt is now a Firestore Timestamp object

// To convert to JavaScript Date:
const createdDate = transaction.createdAt.toDate();
const completedDate = transaction.completedAt.toDate();

// To get ISO string:
const createdISO = transaction.createdAt.toDate().toISOString();
```

### Timestamp Object Methods
```javascript
const timestamp = transaction.createdAt; // Firestore Timestamp

timestamp.toDate();        // JavaScript Date object
timestamp.toMillis();      // Unix timestamp in milliseconds
timestamp.seconds;         // Unix timestamp in seconds
timestamp.nanoseconds;     // Nanoseconds part
```

---

## Complete Operation Flow

### Single Monthly Payment (Example: GST Payment)
1. **Create Transaction** in `accountingTransactions`:
   ```javascript
   {
     vehicleId: "abc123",
     type: "gst_payment",
     amount: 4500.00,
     month: "2025-11",
     description: "GST Payment for MH12AB1234 - November 2025",
     status: "completed",
     createdAt: "2025-11-15T14:30:25.123Z",
     completedAt: "2025-11-15T14:30:25.123Z"
   }
   ```

2. **Update Vehicle Cash** in `cashInHand/abc123`:
   ```javascript
   { balance: increment(-4500.00) } // Decreases by ₹4500
   ```

3. **Update Company Cash** in `companyCashInHand/main`:
   ```javascript
   {
     balance: increment(-4500.00), // Decreases by ₹4500
     lastUpdated: "2025-11-15T14:30:25.123Z"
   }
   ```

### Total Impact: 3 collections, 3 documents updated

---

## Key Technical Notes

- **All operations are cash outflows** (negative amounts using `increment(-amount)`)
- **Atomic updates** using Firestore `increment()` for concurrent safety
- **ISO timestamps** stored as strings, retrieved as Timestamp objects
- **Bulk payments** create multiple transaction documents but single cash updates
- **Local state** synchronized after all Firestore operations complete

## Undo Operation Requirements

For proper undo functionality, each transaction must be reversed by:

1. **Update transaction status**: `'completed'` → `'reversed'`
2. **Add `reversedAt` timestamp**: `new Date().toISOString()`
3. **Reverse cash balances**: `increment(+originalAmount)` to add money back
4. **Update local state** to reflect changes

This document contains the complete specification for implementing payment collection and undo functionality.</content>
<parameter name="filePath">d:\Easy2SolutionsProjects\EasyProjects-Web\TransportationMgt\route-glide-transpo-hub\PAYMENT_COLLECTION_OPERATIONS_DETAILED.md